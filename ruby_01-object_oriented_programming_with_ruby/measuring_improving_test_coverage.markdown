---
title: Measuring and Improving Test Coverage
tags: testing, tdd, coverage, ruby
---

# Measuring and Improving Test Coverage

## Objectives

* measure test coverage using the SimpleCov gem
* interpret the results generated by `SimpleCov.start`

## Materials

* Repo [here](https://github.com/rwarbelow/measuring_and_improving_test_coverage).

## What is code coverage?

Code coverage is the measure of how many lines of code are executed by your test suite. Generally, you should strive for close to 100%. 

## What code coverage is not

Being purely "did this line get hit?", coverage does not show that the line was hit *meaningfully*. You still need to think about your tests. It is a *supplementary* tool; it doesn't compensate for your brain.

## SimpleCov

### What is SimpleCov?

[SimpleCov](https://github.com/colszowka/simplecov/) is a tool that records which lines of code were executed while a program is running. It then generates a report so that the developer can look at it and infer information about what code is active/dead, or in our case, how much of our code the test suite covers.

### Try it out

First, install simplecov with `gem install simplecov`.

Now, check out `speeding_ticket_example/speeding_ticket_test.rb`. 

* Which lines would you expect to get covered in the `speeding_ticket_example/speeding_ticket` file based on the test? 
* Run the test with `ruby speeding_ticket_test.rb` to generate the report. Make sure you are running the test from within the test directory. Notice the "Coverage report generated..." message at the bottom of the output. 
* Open the coverage report `open coverage/index.html`, notice it tells you some information on this page, including the filename and its percentage covered. 
* Now click the filename, "speeding_ticket.rb", to see the report. Was your guess correct?

## What it looks like for a given method

* What does the percentage refer to?
* What are relevant lines vs. all lines?
* What lines were covered?
* What lines were missed?
* How many times was each line hit?

From this, we can see we should add a test for when speed is 4 or more times the speed limit.

But we can't see that we should consider adding a test for when none of the conditions hit. SimpleCov won't tell us what tests are missing; it will only tell us which lines of our code are covered and not covered by our current tests. 

### How it works

Start SimpleCov at the beginning of your test file (or wherever you want to start recording coverage).

```ruby
require 'simplecov'
SimpleCov.start
```

It then uses Ruby's [Coverage API](http://rdoc.info/stdlib/coverage/Coverage) to identify which lines were executed.

When we finish running, Simplecov hooks into Ruby's exit event (https://github.com/colszowka/simplecov/blob/fee9dcf1f990a57503b0d518d9844a7209db4734/lib/simplecov/defaults.rb#L42)
and writes the data it recorded to an html file we can open in our browser to see the results.

We can see the data that it generated by looking at coverage/.resultset.json

```json
{
  "MiniTest": {
    "coverage": {
      "/Users/rwarbelow/speeding_ticket_example/speeding_ticket.rb": [
        1,
        2,
        2,
        0,
        2,
        1,
        1,
        1,
        null,
        null,
        null
      ]
    },
    "timestamp": 1416323649
  }
}
```

SimpleCov takes this information and matches it up to the source file,
adding the coverage information to each line and displaying them
in a static html page.

### When to load it

SimpleCov cannot see files that were loaded before it started.
This means that it needs to be the first thing required (it ignores files required before its definition).
Typically, we would put it in a test helper file, and have every test file
require the helper first.

### Where is the report?

The report that SimpleCov generates is in the "coverage" folder.
You can view it by looking at "index.html" in that folder.

### Gitignore

Don't commit your coverage folder. Add it to your `.gitignore`. 

### Where are the docs?

Want to know more about SimpleCov than we covered today? Documentation is on the [github page](https://github.com/colszowka/simplecov/).

There is information about how files are filtered (ie - filter additional files/folders),
omitting code from the report, declaring profiles (you get a default one that
scopes the report to only code in your project root, but it also sees code
that is executed in gems and Ruby Core and more)! It shows you how you can
have it fail the running program if your code coverage doesn't hit some minimum
threshold (e.g. 90%).

### What about when it gets all messed up?

Sometimes, while trying to aggregate results (e.g. if you have more than one test suite)
it can get messed up. When this happens `rm -r coverage` and run again.

## Questions:

* We've talked about what it means if a line is not executed.
  But what might we conclude if a line gets hit a whole bunch of times?
* Should you put your coverage directory in git?

## How seriously should you take this?

Not **too** seriously. It's just a metric you can use to get some information,
it doesn't define what good coverage is, as you saw, we still need to use our brains.
In the end, you need to make the right decision for your project based on the context
that you have, and this is one way to get information about the context.

## Your turn!

With your pair, decide on one of the options below:

1) Take a previous project (either from Turing or on your own) and add SimpleCov. Look at your code coverage and add tests for parts that are not covered. 

2) Implement a passenger class and a bus class that interact with each other (this interaction is up to you). As you're building out tests and features, run SimpleCov to make sure you have tests to cover your functionality. 
